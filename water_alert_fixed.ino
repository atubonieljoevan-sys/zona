'#include <SoftwareSerial.h>\n#include <Wire.h>\n#include <LiquidCrystal_I2C.h>\n\nSoftwareSerial SIM900A(2, 3);\n\n#define WATER_SENSOR_PIN A0\n#define TRIG_PIN 8\n#define ECHO_PIN 9\n\nLiquidCrystal_I2C lcd(0x27, 16, 2);\n\n// Extended phone numbers list - 10 total recipients\nconst char* phoneNumbers[] = {\n  "+639161803526",\n  "+639354546348",\n  "+639518081428",\n  "+639060382870",\n  "+639677204640",\n  "+639559505896",\n  "+639556197755",\n  "+639671698782",\n  "+639975320870",\n  "+639636628562"\n};\nint numPhones = 10;\n\n#define WATER_LEVEL_7CM 200\n#define WATER_LEVEL_5CM 150\n#define WATER_LEVEL_2CM 100\n\n#define ULTRASONIC_7CM 100\n#define ULTRASONIC_5CM 80\n#define ULTRASONIC_2CM 50;\n\nint currentWaterLevel = 0;\nfloat currentDistance = 0;\nfloat waterLevelCM = 0;\nint currentAlertLevel = 0;\nbool waterDetected = false;\nbool ultrasonicDetected = false;\nbool alertAlreadySent = false;\nint displayMode = 0;\n\nunsigned long lastModeChange = 0;\nconst unsigned long MODE_CHANGE_INTERVAL = 3000;\n\n// Buffer for incoming messages\nchar incomingBuffer[200] = "";\nint bufferIndex = 0;\n\nvoid setup() {\n  SIM900A.begin(9600);\n  Serial.begin(9600);\n  Wire.begin();\n  \n  lcd.init();\n  lcd.backlight();\n  lcd.clear();\n  \n  pinMode(WATER_SENSOR_PIN, INPUT);\n  pinMode(TRIG_PIN, OUTPUT);\n  pinMode(ECHO_PIN, INPUT);\n  \n  // Startup\n  lcd.setCursor(0, 0);\n  lcd.print("Water Alert");\n  lcd.setCursor(0, 1);\n  lcd.print("Init SIM900");\n  \n  Serial.println("=== Water Alert System ===");\n  Serial.println("Initializing SIM900...");\n  \n  // Basic initialization\n  SIM900A.println("AT");\n  delay(1000);\n  \n  // Set SMS mode to text (not PDU)\n  SIM900A.println("AT+CMGF=1");\n  delay(1000);\n  \n  // Disable echo\n  SIM900A.println("ATE0");\n  delay(1000);\n  \n  // Set SMS alerts - CRITICAL FOR RECEIVING MESSAGES\n  // +CNMI: (mode,mt,bm,ds) - Enable unsolicited result codes for incoming SMS\n  SIM900A.println("AT+CNMI=2,1,0,1");\n  delay(1000);\n  \n  // Enable character set UTF-8\n  SIM900A.println("AT+CSCS=\"GSM\"");\n  delay(1000);\n  \n  // Set message format to text mode\n  SIM900A.println("AT+CMGF=1");\n  delay(1000);\n  \n  // Delete old SMS from storage to free space\n  SIM900A.println("AT+CMGD=1,4");\n  delay(2000);\n  \n  // Clear any leftover data\n  while (SIM900A.available()) {\n    SIM900A.read();\n  }\n  \n  delay(2000);\n  \n  lcd.clear();\n  lcd.setCursor(0, 0);\n  lcd.print("Ready!");\n  lcd.setCursor(0, 1);\n  lcd.print("Monitoring");\n  \n  Serial.println("System Ready!");\n  Serial.println("Alert will be sent to 10 recipients:");\n  for (int i = 0; i < numPhones; i++) {\n    Serial.print("  ");\n    Serial.print(i + 1);\n    Serial.print(". ");\n    Serial.println(phoneNumbers[i]);\n  }\n  Serial.println("Waiting for incoming messages...\n");\n  \n  delay(2000);\n  \n  lastModeChange = millis();\n}\n\nvoid loop() {\n  // CHECK FOR INCOMING MESSAGES FIRST\n  CheckIncomingMessages();\n  \n  currentWaterLevel = analogRead(WATER_SENSOR_PIN);\n  currentDistance = measureDistance();\n  waterLevelCM = 30.0 - currentDistance;\n  if (waterLevelCM < 0) waterLevelCM = 0;\n  \n  waterDetected = (currentWaterLevel >= WATER_LEVEL_2CM);\n  ultrasonicDetected = (currentDistance <= ULTRASONIC_7CM);\n  \n  // Rotate display every 3 seconds\n  if (millis() - lastModeChange > MODE_CHANGE_INTERVAL) {\n    displayMode = (displayMode + 1) % 3;\n    lastModeChange = millis();\n  }\n  \n  // Display on LCD - ROTATING DISPLAY\n  DisplayRotatingScreen();\n  \n  Serial.print("Water Analog: ");\n  Serial.print(currentWaterLevel);\n  Serial.print(" | Distance: ");\n  Serial.print(currentDistance);\n  Serial.print("cm | Level: ");\n  Serial.print((int)waterLevelCM);\n  Serial.print("cm | Status: ");\n  Serial.println(currentAlertLevel == 0 ? "NORMAL" : "ALERT");\n  \n  // Alert logic\n  if (waterDetected && ultrasonicDetected) {\n    if (!alertAlreadySent) {\n      \n      if (currentWaterLevel >= WATER_LEVEL_7CM && currentDistance <= ULTRASONIC_7CM) {\n        currentAlertLevel = 1;\n        SendAlert("CAUTION", waterLevelCM);\n        alertAlreadySent = true;\n      }\n      else if (currentWaterLevel >= WATER_LEVEL_5CM && currentDistance <= ULTRASONIC_5CM) {\n        currentAlertLevel = 2;\n        SendAlert("WARNING", waterLevelCM);\n        alertAlreadySent = true;\n      }\n      else if (currentWaterLevel >= WATER_LEVEL_2CM && currentDistance <= ULTRASONIC_2CM) {\n        currentAlertLevel = 3;\n        SendAlert("DANGER", waterLevelCM);\n        alertAlreadySent = true;\n      }\n    }\n  }\n  else if (alertAlreadySent) {\n    currentAlertLevel = 0;\n    alertAlreadySent = false;\n  }\n  \n  delay(500);\n}\n\n// NEW FUNCTION: Check for incoming messages\nvoid CheckIncomingMessages() {\n  if (SIM900A.available() > 0) {\n    char incomingChar = SIM900A.read();\n    \n    // Print to serial for debugging\n    Serial.print(incomingChar);\n    \n    // Store in buffer\n    if (bufferIndex < 199) {\n      incomingBuffer[bufferIndex] = incomingChar;\n      bufferIndex++;\n      incomingBuffer[bufferIndex] = '\0';\n    }\n    \n    // Check if we received a complete incoming message\n    if (strstr(incomingBuffer, "+CMT:") != NULL) {\n      Serial.println("\n=== SMS RECEIVED ===");\n      Serial.print(incomingBuffer);\n      \n      // Display on LCD\n      lcd.clear();\n      lcd.setCursor(0, 0);\n      lcd.print("SMS Received!");\n      lcd.setCursor(0, 1);\n      lcd.print("Check Serial");\n      \n      delay(3000);\n      \n      // Reset buffer\n      bufferIndex = 0;\n      memset(incomingBuffer, 0, sizeof(incomingBuffer));\n    }\n    \n    // Check for OK or ERROR responses\n    if (strstr(incomingBuffer, "OK") != NULL || strstr(incomingBuffer, "ERROR") != NULL) {\n      if (strlen(incomingBuffer) > 3) {  // Make sure it's not too short\n        Serial.print(incomingBuffer);\n        bufferIndex = 0;\n        memset(incomingBuffer, 0, sizeof(incomingBuffer));\n      }\n    }\n  }\n}\n\n// ROTATING LCD DISPLAY - Shows different info every 3 seconds\nvoid DisplayRotatingScreen() {\n  lcd.clear();\n  \n  if (displayMode == 0) {\n    // Mode 0: Water Level in CM\n    lcd.setCursor(0, 0);\n    lcd.print("Water Level:");\n    \n    lcd.setCursor(0, 1);\n    lcd.print((int)waterLevelCM);\n    lcd.print("cm");\n    \n    if (currentAlertLevel == 1) {\n      lcd.print(" CAUTION");\n    } else if (currentAlertLevel == 2) {\n      lcd.print(" WARNING");\n    } else if (currentAlertLevel == 3) {\n      lcd.print(" DANGER");\n    } else {\n      lcd.print(" NORMAL");\n    }\n  }\n  else if (displayMode == 1) {\n    // Mode 1: Distance (Ultrasonic)\n    lcd.setCursor(0, 0);\n    lcd.print("Distance:");\n    \n    lcd.setCursor(0, 1);\n    lcd.print((int)currentDistance);\n    lcd.print("cm away");\n  }\n  else if (displayMode == 2) {\n    // Mode 2: Sensor Reading (Analog)\n    lcd.setCursor(0, 0);\n    lcd.print("Sensor Reading:");\n    \n    lcd.setCursor(0, 1);\n    lcd.print(currentWaterLevel);\n    lcd.print(" (Analog)");\n  }\n}\n\nfloat measureDistance() {\n  digitalWrite(TRIG_PIN, LOW);\n  delayMicroseconds(2);\n  digitalWrite(TRIG_PIN, HIGH);\n  delayMicroseconds(10);\n  digitalWrite(TRIG_PIN, LOW);\n  \n  long duration = pulseIn(ECHO_PIN, HIGH);\n  float distance = duration / 58.0;\n  \n  return distance;\n}\n\nvoid SendAlert(const char* alertType, float level) {\n  Serial.print("\n=== Sending ");\n  Serial.print(alertType);\n  Serial.println(" Alert ===");\n  \n  lcd.clear();\n  lcd.setCursor(0, 0);\n  lcd.print("Sending SMS...");\n  lcd.setCursor(0, 1);\n  lcd.print(alertType);\n  \n  for (int i = 0; i < numPhones; i++) {\n    Serial.print("Sending to ");\n    Serial.print(i + 1);\n    Serial.print("/");\n    Serial.print(numPhones);\n    Serial.print(" (");\n    Serial.print(phoneNumbers[i]);\n    Serial.println(")...");\n    \n    SIM900A.println("AT+CMGF=1");\n    delay(1000);\n    \n    SIM900A.print("AT+CMGS=\"");\n    SIM900A.print(phoneNumbers[i]);\n    SIM900A.println("\"");\n    delay(1000);\n    \n    String msg = alertType;\n    msg += ": Water level at ";\n    msg += (int)level;\n    msg += "cm, Distance: ";\n    msg += (int)currentDistance;\n    msg += "cm!";\n    \n    SIM900A.println(msg);\n    delay(500);\n    SIM900A.write(26);\n    delay(2000);\n    \n    Serial.print("âœ“ Sent successfully!");\n    delay(1000);\n  }\n  \n  Serial.println("\n=== All SMS sent! ===\n");\n  \n  // Update LCD after sending all\n  delay(1000);\n  lcd.clear();\n  lcd.setCursor(0, 0);\n  lcd.print("All SMS Sent!");\n  lcd.setCursor(0, 1);\n  lcd.print("10 Recipients");\n  \n  delay(2000);\n'}